require 'tempfile'

ERB = ENV['MY_ERB']
CPP = ENV['MY_CPP']
GFORTRAN = ENV['MY_GFORTRAN']

ERBED_F90_FILES = FileList['*.F90.erb'].ext('')

desc "Compile erb files."
task erb: ERBED_F90_FILES

rule '.F90' => '.F90.erb' do |t|
  begin
    sh "#{ERB} #{t.source} > #{t.name}"
  rescue
    if File.exist?(t.name)
      if File.zero?(t.name)
        rm t.name
      else
        mv t.name, "#{t.name}.fail"
      end
    end
  end
end

%w[.o .mod].each{|ext|
  rule ext => '.F90' do |t|
    sh "#{GFORTRAN} -c #{t.source}"
  end
}

# `sh' is too verbose for automatic test.
def run_test(t)
  system "#{GFORTRAN} -o #{t.name} #{t.prerequisites.join(' ')} && ./#{t.name}"
end

TEST_FILES = FileList['*_test.F90', '*_test.F90.erb'].sub(/\.F90(?:\.erb)?\z/, '.exe')
task test: TEST_FILES
{
  "lib_comparable_test.exe" => %w[lib_constant.o lib_comparable.o lib_comparable_test.F90],
  "lib_character_test.exe" => %w[lib_character.o lib_character_test.F90],
  "lib_constant_test.exe" => %w[lib_comparable.o lib_constant.o lib_constant_test.F90],
}.each{|target, dependencies|
  file target => dependencies do |t|
    run_test(t)
  end
}
