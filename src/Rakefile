ERB = ENV.fetch('MY_ERB') + ' -T - -P'
GFORTRAN = ENV.fetch('MY_GFORTRAN') + ' -DDEBUG -ffree-line-length-none -fmax-identifier-length=63 -ggdb -fbacktrace -fbounds-check -pipe -Wall -O0 -C -cpp'

ERBED_F90_FILES = FileList['*.F90.erb'].ext('')

desc "Alias of test."
task default: :test

desc "Compile erb files."
task erb: ERBED_F90_FILES

rule '.F90' => '.F90.erb' do |t|
  begin
    sh "#{ERB} #{t.source} > #{t.name}"
  rescue
    if File.exist?(t.name)
      if File.zero?(t.name)
        rm t.name
      else
        mv t.name, "#{t.name}.fail"
      end
    end
  end
end

%w[.o .mod].each{|ext|
  rule ext => '.F90' do |t|
    sh "#{GFORTRAN} -c #{t.source}"
  end
}

# `sh' is too verbose for automatic test.
def run_test(t, failed_tests)
  failed_tests << t.name unless system "#{GFORTRAN} -o #{t.name} #{t.prerequisites.join(' ')} && ./#{t.name}"
end

TEST_FILES = FileList['*_test.F90', '*_test.F90.erb'].sub(/\.F90(?:\.erb)?\z/, '.exe')
FAILED_TESTS = []

task testing: TEST_FILES
{
  "lib_comparable_test.exe" => %w[lib_constant.o lib_comparable.o lib_comparable_test.o],
  "lib_character_test.exe" => %w[lib_character.o lib_character_test.o],
  "lib_constant_test.exe" => %w[lib_comparable.o lib_constant.o lib_constant_test.o],
  "lib_sort_test.exe" => %w[lib_constant.o lib_fortran.o lib_comparable.o lib_sort.o lib_sort_test.o],
  "lib_list_test.exe" => %w[lib_comparable.o lib_list.o lib_list_test.o],
  "lib_fortran-stack_test.exe" => %w[lib_fortran.o lib_fortran-stack_test.o],
  "lib_fortran-queue_test.exe" => %w[lib_fortran.o lib_fortran-queue_test.o],
  "lib_io_test.exe" => %w[lib_constant.o lib_character.o lib_comparable.o lib_io.o lib_io_test.o],
  "lib_fortran_binary_tree_map_test.exe" => %w[lib_fortran.o lib_fortran_binary_tree_map_test.o],
  "sac_lib_test.exe" => %w[sac_lib.o sac_lib_test.o],
}.each{|target, dependencies|
  file target => dependencies do |t|
    run_test(t, FAILED_TESTS)
  end
}

def run_errortest(t, failed_tests)
  system "#{GFORTRAN} -o #{t.name} #{t.prerequisites.join(' ')}"
  if system "./#{t.name} 2> #{::File::NULL}"
    failed_tests << t.name
  else
    puts ". SUCCESS: #{File.basename(t.name, '.exe') + '.F90'}"
  end
end

ERRORTEST_FILES = FileList['*_errortest.F90', '*_errortest.F90.erb'].sub(/\.F90(?:\.erb)?\z/, '.exe')
FAILED_ERRORTESTS = []

desc "Run tests."
task test: [:testing, :errortesting] do
  unless FAILED_TESTS.empty? && FAILED_ERRORTESTS.empty?
    puts "FAILED TESTS:"
    puts FAILED_TESTS + FAILED_ERRORTESTS
    exit 1
  end
end

task errortesting: ERRORTEST_FILES
{
  "sac_lib_iftype_errortest.exe" => %w[sac_lib.o sac_lib_iftype_errortest.o],
  "sac_lib_kstnm_errortest.exe" => %w[sac_lib.o sac_lib_kstnm_errortest.o],
  "sac_lib_kevnm_errortest.exe" => %w[sac_lib.o sac_lib_kevnm_errortest.o],
  "lib_fortran_binary_tree_map_add_too_long_key_errortest.exe" => %w[lib_fortran.o lib_fortran_binary_tree_map_add_too_long_key_errortest.o],
}.each{|target, dependencies|
  file target => dependencies do |t|
    run_errortest(t, FAILED_ERRORTESTS)
  end
}
