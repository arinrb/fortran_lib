<%-
def enlarge(sml_n, scale)
  sml_n\
    .map{|array| array\
      .map{|n| n*scale}}\
    .map{|array| [array, array.sort]}
end

SCALE_UNI = 1
SCALE_I = 2**31 - 1
SCALE_F = 3.402823E+38

SML = [-1, 0, 1]
SML_SETS = [
  SML.product(SML),
  SML.product(SML, SML),
  SML.product(SML, SML, SML),
  SML.product(SML, SML, SML, SML),
]
-%>

#include "utils.h"
program lib_sort_test
  USE_UTILS_H
  use, intrinsic:: iso_fortran_env, only: OUTPUT_UNIT
  use lib_constant, only: get_infinity
  use lib_comparable, only: equivalent
  use lib_sort

  implicit none

  Integer:: i

  ! size 0
  test(size(quick_sort([(i, i = 1, 0)])) == 0)
  test(size(quick_sort([(dble(i), i = 1, 0)])) == 0)
  test(size(merge_sort([(i, i = 1, 0)])) == 0)
  test(size(merge_sort([(dble(i), i = 1, 0)])) == 0)

  ! size 1
  test(all(quick_sort([0]) == [0]))
  test(all(equivalent(quick_sort([0.0]), [0.0])))
  test(all(merge_sort([0]) == [0]))
  test(all(equivalent(merge_sort([0.0]), [0.0])))

  <%- [SML_SETS.last].each{|sml_set| -%>
    <%- enlarge(sml_set, SCALE_UNI).each{|input, sorted| -%>
      test(all(quick_sort(<%= input.inspect %>) == <%= sorted.inspect %>))
      test(all(merge_sort(<%= input.inspect %>) == <%= sorted.inspect %>))
    <%- } -%>

    <%- enlarge(sml_set, SCALE_I).each{|input, sorted| -%>
      test(all(quick_sort(<%= input.inspect %>) == <%= sorted.inspect %>))
      test(all(merge_sort(<%= input.inspect %>) == <%= sorted.inspect %>))
    <%- } -%>

    <%- enlarge(sml_set, SCALE_F).each{|input, sorted| -%>
      test(all(equivalent(quick_sort(<%= input.inspect %>), <%= sorted.inspect %>)))
      test(all(equivalent(merge_sort(<%= input.inspect %>), <%= sorted.inspect %>)))
    <%- } -%>
  <%- } -%>

  <%- 1.times{|i| -%>
    <%- randoms = (0...1000).map{rand*0.01 - 0.005} -%>
    <%- sorted = randoms.sort -%>
    test(all(equivalent(quick_sort(<%= randoms.inspect %>), <%= sorted.inspect %>)))
    test(all(equivalent(merge_sort(<%= randoms.inspect %>), <%= sorted.inspect %>)))
  <% } %>

  ! Infinity
  test(all(equivalent(quick_sort([0.0, get_infinity(), -get_infinity()]), [-get_infinity(), 0.0, get_infinity()])))
  test(all(equivalent(merge_sort([0.0, get_infinity(), -get_infinity()]), [-get_infinity(), 0.0, get_infinity()])))

  ! Bug check
  test(all(equivalent(quick_sort([0.992602646, 0.992602706]), [0.992602646, 0.992602706])))
  test(all(equivalent(merge_sort([0.992602646, 0.992602706]), [0.992602646, 0.992602706])))

  write(OUTPUT_UNIT, *) 'SUCCESS: ', __FILE__
  stop
end program lib_sort_test
