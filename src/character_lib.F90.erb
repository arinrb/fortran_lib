<%
  require 'fort'

  INT_TYPES = ::Fort::Type::Integer.multi_provide(dim: 0)
  TYPES\
  = ::Fort::Type::Logical.multi_provide(dim: 0)\
  + ::Fort::Type::Real.multi_provide(dim: 0)\
  + ::Fort::Type::Complex.multi_provide(dim: 0)\
  + ::Fort::Type::Character.multi_provide\
  + INT_TYPES
%>
module character_lib
   <%= ::Fort::Type::USE_ISO_FORTRAN_ENV %>

   implicit none

   private

   public:: s                    ! Same as String#strip method in Ruby.
   public:: operator(+)          ! Syntax sugar of `//'. This will be useful if you want to use `//' within macro where `//' is discarded.
   ! public:: str
   public:: str_fixed            ! Convert a value to a string. The result is not stripped.

   integer, parameter, public:: MAX_STR_LEN = 2**11  ! Maximum length of str.

   interface operator(+)
      module procedure add
   end interface operator(+)

   <%- TYPES.each{|t| -%>
      ! interface str
      !    module procedure str<%= t %>
      ! end interface str

      interface str_fixed
         module procedure str_fixed<%= t %>
      end interface str_fixed
   <%- } -%>

contains

   pure function s(str) result(answer)
      character(len = *), intent(in):: str
      character(len = len_trim(adjustl(str))):: answer

      answer = trim(adjustl(str))
   end function s

   elemental function add(str1, str2) result(answer)
      character(len = *), intent(in):: str1, str2
      character(len = len(str1) + len(str2)):: answer

      answer = str1 // str2
   end function add

   <%- TYPES.each{|t| -%>
      pure function str_fixed<%= t %>(x) result(answer)
         character(len = STR_LEN):: answer
         <%= t.declare %>, intent(in):: x

         write(answer, *) x
         answer = s(answer)
      end function str_fixed<%= t %>

      ! ! This is not work on ifort
      ! pure function str<%= t %>(x) result(answer)
      !    <%= t.declare %>, intent(in):: x
      !    character(len = len(s(str_fixed(x)))):: answer

      !    answer = s(str_fixed(x))
      ! end function str<%= t %>
   <%- } -%>
end module character_lib
